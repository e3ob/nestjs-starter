name: Deploy to Staging

on:
  pull_request:
    types: [opened, synchronize, labeled]
    paths:
      - 'apps/api/**'
  push:
    paths:
      - 'apps/api/**'
    branches-ignore:
      - 'main'

jobs:
  check-pr:
    runs-on: ubuntu-latest
    outputs:
      has-label: ${{ steps.check-label.outputs.has_label }}
    steps:
      - name: Check Associated PR Label
        id: check-label
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # For PR events, check the current PR
            HAS_LABEL=$(jq 'any(.labels[]; .name == "deploy-dev")' <<< '${{ toJSON(github.event.pull_request) }}')
          else
            # For push events, find associated PR and check its labels
            PR_DATA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:${{ github.ref_name }}&state=open")
            HAS_LABEL=$(echo "$PR_DATA" | jq 'any(.[].labels[]; .name == "deploy-dev")')
          fi
          if [ "$HAS_LABEL" == "true" ]; then
            printf "This PR has 'deploy-dev' label.\n\nPushing to staging..."
          else
            printf "This PR does not have the 'deploy-dev' label.\n\nSkipping deployment..."
          fi
          echo "has_label=$HAS_LABEL" >> $GITHUB_OUTPUT

  build:
    needs: check-pr
    if: needs.check-pr.outputs.has-label == 'true'
    uses: ./.github/workflows/build.yml
    with:
      branch: main
    permissions:
      contents: read
      packages: write

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Staging
        run: echo "Deploying image tagged as 'dev' to staging environment."
